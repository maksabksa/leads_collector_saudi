# منصة تحليل التسويق الرقمي - Leads Collector Saudi

## قاعدة البيانات والـ Backend
- [x] تصميم schema: جداول leads, zones, website_analyses, social_analyses
- [x] تطبيق migration SQL
- [x] كتابة DB helpers في server/db.ts
- [x] إنشاء tRPC routers: leads, zones, analysis, export

## واجهة المستخدم
- [x] تصميم CSS variables والثيم الاحترافي (dark elegant) مع خط IBM Plex Arabic
- [x] بناء Layout مع sidebar عربي RTL
- [x] صفحة لوحة التحكم الرئيسية (Dashboard) مع إحصائيات وتقدم الهدف
- [x] صفحة إدارة المناطق الجغرافية (Zones) - 22 منطقة تلقائية
- [x] صفحة قائمة Leads مع فلترة وبحث وتصدير
- [x] نموذج إدخال Lead جديد (Add Lead Form) مع تحقق
- [x] صفحة تفاصيل Lead مع التحليلات الكاملة

## محللات التسويق الرقمي
- [x] محلل المواقع الإلكترونية (Website Analyzer) مع LLM
- [x] محلل السوشيال ميديا (Social Media Analyzer) مع LLM
- [x] نظام تقييم الثغرات التسويقية
- [x] توليد زاوية الدخول البيعية (Sales Entry Angle)
- [x] تقرير شامل بالذكاء الاصطناعي (Full Report)

## التقارير والتصدير
- [x] تقرير تفصيلي لكل Lead
- [x] تصدير CSV مع فلترة
- [ ] تصدير Excel (مستقبلي)
- [ ] تصدير PDF (مستقبلي)

## الاختبارات
- [x] Vitest tests للـ routers الرئيسية (6 اختبارات تمر)
- [x] التحقق من صحة البيانات في النماذج

## نظام البحث اليدوي التفاعلي (جديد)
- [x] صفحة البحث: حقل نوع النشاط + المدينة + زر بحث
- [x] Backend: Google Places Text Search API proxy في tRPC
- [x] Backend: Google Places Details API لجلب الهاتف والموقع والتفاصيل
- [x] عرض نتائج البحث في بطاقات مع الاسم والهاتف والعنوان والتقييم
- [x] زر "أضف كـ Lead" في كل بطاقة نتيجة مع إضافة فورية للقاعدة
- [x] منع التكرار: تنبيه إذا كان العميل موجود مسبقاً
- [x] إضافة صفحة البحث للـ sidebar

## المتصفح المدمج (Browser Scout)
- [ ] صفحة متصفح مدمج مع iframe وشريط عناوين قابل للتعديل
- [ ] اختصارات سريعة للمنصات (إنستغرام، سناب شات، تيك توك، Google Maps، LinkedIn)
- [ ] لوحة جانبية لاستخراج البيانات يدوياً (اسم، هاتف، نوع النشاط، روابط)
- [ ] زر "أضف كـ Lead" من اللوحة الجانبية مباشرة
- [ ] إضافة الصفحة للـ sidebar بأيقونة متصفح

## التحسينات الجديدة (الدفعة الثانية)
- [x] فلتر مصدر البحث في صفحة البحث (إنستغرام، فيسبوك، تيليغرام، Google Maps، الكل)
- [x] روابط مباشرة تفتح المنصة المختارة بكلمة البحث تلقائياً
- [x] صفحة Browser Scout مع نموذج استخراج بيانات يدوي
- [x] حفظ تلقائي (auto-save) بعد 2.5 ثانية من توقف الكتابة بدون زر
- [x] تحليل مباشر مدمج في صفحة بيانات العميل (LeadDetail)
- [x] تحديث تصدير CSV: كل بيانات العميل + تحليل الموقع + تحليل سوشيال في صف واحد

## التطوير الشامل - الدفعة الثالثة

### فلتر الدول والمدن
- [x] إضافة حقل country للـ leads في قاعدة البيانات
- [x] قاموس شامل: 10+ دول عربية مع مدنها الرئيسية (shared/countries.ts)
- [x] فلتر الدولة → يحدث قائمة المدن تلقائياً في جميع الصفحات
- [x] تحديث صفحة Leads بفلتر الدولة والمدينة
- [x] تحديث صفحة AddLead بفلتر الدولة والمدينة
- [ ] تحديث صفحة Search بفلتر الدولة والمدينة
- [ ] تحديث Dashboard بإحصائيات حسب الدولة

### محرك البحث الذكي في الخلفية
- [x] جدول search_jobs في قاعدة البيانات (المهمة، الحالة، التقدم، النتائج)
- [x] tRPC router لإدارة مهام البحث (إنشاء، متابعة، إيقاف)
- [x] خوارزمية البحث المنهجي: تقسيم المدينة لمناطق + بحث متعدد الكلمات
- [x] منع التكرار: فحص رقم الهاتف والاسم قبل الإضافة
- [x] تأخير بشري عشوائي بين الطلبات (2-5 ثوانٍ)
- [x] صفحة "محرك البحث" مع واجهة إنشاء مهام وتتبع حي
- [x] مؤشر تقدم حي مع عداد النتائج المكتشفة
- [x] إشعار عند اكتمال المهمة

## محرك البحث متعدد المنصات - الدفعة الرابعة
- [x] خيار Google Maps: بحث تلقائي كامل عبر Places API
- [x] خيار سناب شات: يفتح بحث سناب + نموذج استخراج يدوي
- [x] خيار إنستغرام: يفتح بحث إنستغرام + نموذج استخراج يدوي
- [x] خيار تيك توك: يفتح بحث تيك توك + نموذج استخراج يدوي
- [x] خيار فيسبوك: يفتح بحث فيسبوك + نموذج استخراج يدوي
- [x] خيار معروف.sa: يفتح معروف مع الكلمة المفتاحية + نموذج استخراج يدوي
- [x] خيار الكل: يشغّل Google Maps تلقائياً + يفتح باقي المنصات في تبويبات
- [x] واجهة موحدة: اختيار المنصة يغير طريقة العمل (تلقائي vs يدوي)
- [x] مؤشر واضح: "تلقائي كامل" أو "يدوي مساعد" لكل منصة

## الدفعة الخامسة - تحسينات جوهرية
- [x] تغيير اسم التطبيق إلى "بحثي - مجمع البيانات"
- [x] رفع حد الـ Leads إلى ما لا نهاية (إزالة الحد 400)
- [x] تحديث لوحة التحكم لعرض التقدم بدون حد (∞)
- [x] دمج AI في البحث اليدوي: توليد استراتيجية بحث ذكية لكل منصة ونشاط
- [x] AI يقترح hashtags وكلمات بحث مخصصة لكل نشاط ومنصة
- [x] AI يحلل البيانات المدخلة يدوياً ويقيّم جودة العميل (1-10)
- [x] AI يقترح زاوية التواصل المثلى بناءً على نوع النشاط والمنصة

## الدفعة السادسة - تاريخ السوشيال + تحليل تلقائي
- [x] إضافة حقل socialSince (تاريخ الظهور على السوشيال) في schema
- [x] migration لإضافة العمود الجديد
- [x] تحديث DB helpers لدعم socialSince
- [x] تحديث leads.create ليُشغّل التحليل تلقائياً بعد الحفظ (setImmediate)
- [x] تحديث صفحة AddLead بحقل socialSince
- [x] تحديث صفحة LeadDetail لعرض socialSince
- [x] تحديث صفحة Leads لعرض socialSince في الجدول

## الدفعة السابعة - نظام واتساب المتكامل

- [ ] إضافة حقل hasWhatsapp + whatsappCheckedAt في جدول leads
- [ ] إضافة جدول whatsapp_messages لتتبع الرسائل المرسلة
- [ ] migration لإضافة الحقول والجدول الجديد
- [ ] tRPC router: checkWhatsapp (فحص وجود واتساب عبر wa.me)
- [ ] tRPC router: generateWhatsappMessage (AI يولد رسالة مخصصة)
- [ ] tRPC router: logWhatsappMessage (تسجيل الرسالة المرسلة)
- [ ] tRPC router: bulkWhatsapp (إرسال مجمع لقائمة عملاء)
- [ ] زر فحص واتساب في LeadDetail مع مؤشر ✅/❌
- [ ] زر "إرسال واتساب" يفتح wa.me مع الرسالة المولّدة بالـ AI
- [ ] صفحة الإرسال المجمع في Leads: اختيار عملاء + توليد رسائل + إرسال
- [ ] عرض حالة واتساب في جدول Leads (أيقونة ملونة)

## الدفعة الثامنة - ميزات متقدمة

- [x] تعديل تأخير واتساب إلى 10 ثواني بين الرسائل (قابل للضبط 3-60 ثانية)
- [x] نظام دعوة المستخدمين بالإيميل مع التحكم بالصلاحيات
- [x] جدول invitations وuser_permissions وwhatsapp_settings وauto_reply_rules في قاعدة البيانات
- [x] صفحة إدارة المستخدمين والصلاحيات (للأدمن فقط) - /users
- [x] صفحة قبول الدعوة - /join?token=...
- [x] ربط أكثر من واتساب (multi-account) - البنية جاهزة
- [x] تبويب الإعدادات في صفحة واتساب مع عرض المحادثات
- [x] تنبيهات الرسائل بعد كل N رسالة (قابل للضبط)
- [x] نظام الرد التلقائي بالذكاء الاصطناعي مع كلمات تفعيل قابلة للتخصيص
- [x] سياق الذكاء الاصطناعي مخصص لكل قاعدة رد
- [x] 16 اختبار Vitest تمر بنجاح

## الدفعة التاسعة - صفحة المحادثات الكاملة

- [x] تحسين backend: إضافة sendChatMessage وmarkAsRead وsearchChats وdeleteChat وgetChatStats
- [x] صفحة /chats: قائمة المحادثات مع بحث وفلتر وعداد الرسائل غير المقروءة
- [x] شات مدمج: عرض سجل الرسائل مع تمييز الصادر والوارد وفواصل التاريخ
- [x] إرسال رسالة مباشرة من الشات
- [x] أرشفة وحذف المحادثات
- [x] ربط المحادثة بالعميل (Lead) مع رابط مباشر
- [x] إضافة صفحة المحادثات للـ sidebar

## الدفعة العاشرة - إعدادات OpenAI Assistant والتحكم بالرد التلقائي

- [x] إضافة جدول ai_settings في قاعدة البيانات (API Key، Assistant ID، System Prompt، إعدادات)
- [x] إضافة حقل aiAutoReplyEnabled في جدول whatsapp_chats (تحكم فردي لكل عميل)
- [x] migration وتطبيق التغييرات
- [x] backend: حفظ وجلب إعدادات AI (إخفاء API Key)
- [x] backend: توليد رد AI باستخدام OpenAI API Key الخاص أو Assistant
- [x] backend: تحكم جماعي - تفعيل/إيقاف الرد لجميع العملاء
- [x] backend: تحكم فردي - تفعيل/إيقاف الرد لعميل محدد
- [x] صفحة /ai-settings: ربط API Key + Assistant ID + System Prompt
- [x] صفحة /ai-settings: اختبار الاتصال بـ OpenAI
- [x] صفحة /ai-settings: مفتاح تفعيل/إيقاف الكل
- [x] صفحة /ai-settings: تحكم فردي لكل محادثة

## الدفعة الحادية عشرة - حسابات واتساب متعددة الأدوار + تحويل للموظف

- [x] جدول whatsapp_accounts: دور (bulk_sender/human_handoff/both)، رقم الواتساب، اسم الموظف، الترتيب
- [x] جدول interest_alerts: تسجيل إشعارات اهتمام العملاء مع حالة التحويل
- [x] migration وتطبيق التغييرات
- [x] backend: CRUD لحسابات واتساب (إضافة/تعديل/حذف/تغيير الدور)
- [x] backend: كشف اهتمام العميل (كلمات مفتاحية + AI) وإنشاء إشعار وإشعار للمالك
- [x] backend: تحويل المحادثة لرقم موظف (رابط wa.me مع بيانات العميل)
- [x] backend: قائمة الإشعارات مع حالة التحويل وإحصائيات
- [x] صفحة /whatsapp-accounts: بطاقات الحسابات مع تحديد الدور وتفعيل/إيقاف
- [x] صفحة /whatsapp-accounts: لوحة إشعارات الاهتمام مع زر التحويل ورابط واتساب
- [x] رابط حسابات واتساب في الـ sidebar تحت قسم الإدارة

## الدفعة الثانية عشرة - توحيد واتساب + كلمات مفتاحية AI + نظام المستخدمين

- [x] توحيد صفحة واتساب: تبويبات موحدة (الربط، القوالب، الإرسال، الإعدادات)
- [x] صفحة /interest-keywords: إدارة كلمات كشف الاهتمام + تدريب AI + اختبار
- [x] 23 كلمة مفتاحية افتراضية مقسمة على 5 فئات (price, buy, interest, contact, general)
- [x] نظام الصلاحيات في الـ sidebar: إخفاء الروابط حسب صلاحيات المستخدم تلقائياً
- [x] جدول interest_keywords وai_training_examples في قاعدة البيانات
- [ ] توحيد صفحة whatsapp-accounts دمجها في صفحة واتساب (مستقبلي)
- [ ] إرسال إيميل فعلي عند إنشاء الدعوة (مستقبلي)

## الدفعة الثالثة عشرة - دمج صفحتي واتساب (حسابات متعددة)

- [ ] فحص الكود الحالي لصفحة WhatsApp.tsx وWhatsAppAccounts.tsx
- [ ] تحديث backend: إضافة accountId لكل QR session وربطه بجدول whatsapp_accounts
- [ ] بناء صفحة واتساب الموحدة: قائمة الحسابات + QR لكل حساب + دور + تفعيل/إيقاف
- [ ] حذف صفحة WhatsAppAccounts.tsx المستقلة
- [ ] تحديث الـ sidebar لإزالة رابط "حسابات واتساب" المكرر

## الدفعة الرابعة عشرة - نظام الشرائح والفلترة المتقدمة

- [ ] جدول segments في قاعدة البيانات (اسم، وصف، لون، أوقات الإرسال المثلى)
- [ ] جدول lead_segments لربط العملاء بالشرائح
- [ ] migration وتطبيق التغييرات
- [ ] backend: CRUD الشرائح + إضافة/حذف عملاء + إحصائيات
- [ ] backend: فلترة العملاء بالشريحة في leads.list
- [ ] صفحة /segments: إنشاء وإدارة الشرائح مع عرض العملاء
- [ ] فلترة متقدمة في صفحة العملاء (المدينة، المصدر، الحالة، الشريحة، التاريخ)
- [ ] إضافة عميل/مجموعة عملاء لشريحة من صفحة العملاء
- [ ] ربط الشريحة بصفحة الإرسال الجماعي (إرسال لشريحة محددة)
- [ ] جدولة الإرسال حسب الوقت المثلى لكل شريحة

## الدفعة الخامسة عشرة - مراجعة شاملة + ميزات جديدة

- [x] إصلاح خطأ segments.list (أعمدة مفقودة في قاعدة البيانات: optimalSendTimes, filterCriteria, isActive, updatedAt)
- [x] إصلاح خطأ getChatMessages عند chatId=null (إضافة guard في backend)
- [x] إصلاح إرسال واتساب في LeadDetail (يرسل عبر النظام الداخلي بدلاً من wa.me خارجياً)
- [x] إعادة تصميم صفحة واتساب: دمج تبويب الربط مع الحسابات + دعم 10 أجهزة
- [x] إضافة فلتر "واتساب فعّال" في قائمة العملاء
- [x] إضافة زر "تحليل جماعي" بضغطة واحدة لتحليل العملاء المحددين
- [x] إضافة bulkAnalyze procedure في analysisRouter
- [x] إضافة hasWhatsapp كفلتر في leads.list procedure وdb.ts
- [x] إنشاء صفحة إعدادات البيانات (/data-settings) مع قوائم منسدلة قابلة للتخصيص
- [x] إنشاء جدول data_settings في قاعدة البيانات
- [x] إنشاء dataSettingsRouter مع CRUD كامل
- [x] تحديث AddLead.tsx لاستخدام القوائم الديناميكية من data_settings
- [x] إضافة "إعدادات البيانات" في قائمة التنقل
- [x] إضافة علامة "واتساب فعّال" في بطاقات العملاء
- [x] 16 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)
