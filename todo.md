# منصة تحليل التسويق الرقمي - Leads Collector Saudi

## قاعدة البيانات والـ Backend
- [x] تصميم schema: جداول leads, zones, website_analyses, social_analyses
- [x] تطبيق migration SQL
- [x] كتابة DB helpers في server/db.ts
- [x] إنشاء tRPC routers: leads, zones, analysis, export

## واجهة المستخدم
- [x] تصميم CSS variables والثيم الاحترافي (dark elegant) مع خط IBM Plex Arabic
- [x] بناء Layout مع sidebar عربي RTL
- [x] صفحة لوحة التحكم الرئيسية (Dashboard) مع إحصائيات وتقدم الهدف
- [x] صفحة إدارة المناطق الجغرافية (Zones) - 22 منطقة تلقائية
- [x] صفحة قائمة Leads مع فلترة وبحث وتصدير
- [x] نموذج إدخال Lead جديد (Add Lead Form) مع تحقق
- [x] صفحة تفاصيل Lead مع التحليلات الكاملة

## محللات التسويق الرقمي
- [x] محلل المواقع الإلكترونية (Website Analyzer) مع LLM
- [x] محلل السوشيال ميديا (Social Media Analyzer) مع LLM
- [x] نظام تقييم الثغرات التسويقية
- [x] توليد زاوية الدخول البيعية (Sales Entry Angle)
- [x] تقرير شامل بالذكاء الاصطناعي (Full Report)

## التقارير والتصدير
- [x] تقرير تفصيلي لكل Lead
- [x] تصدير CSV مع فلترة
- [ ] تصدير Excel (مستقبلي)
- [ ] تصدير PDF (مستقبلي)

## الاختبارات
- [x] Vitest tests للـ routers الرئيسية (6 اختبارات تمر)
- [x] التحقق من صحة البيانات في النماذج

## نظام البحث اليدوي التفاعلي (جديد)
- [x] صفحة البحث: حقل نوع النشاط + المدينة + زر بحث
- [x] Backend: Google Places Text Search API proxy في tRPC
- [x] Backend: Google Places Details API لجلب الهاتف والموقع والتفاصيل
- [x] عرض نتائج البحث في بطاقات مع الاسم والهاتف والعنوان والتقييم
- [x] زر "أضف كـ Lead" في كل بطاقة نتيجة مع إضافة فورية للقاعدة
- [x] منع التكرار: تنبيه إذا كان العميل موجود مسبقاً
- [x] إضافة صفحة البحث للـ sidebar

## المتصفح المدمج (Browser Scout)
- [ ] صفحة متصفح مدمج مع iframe وشريط عناوين قابل للتعديل
- [ ] اختصارات سريعة للمنصات (إنستغرام، سناب شات، تيك توك، Google Maps، LinkedIn)
- [ ] لوحة جانبية لاستخراج البيانات يدوياً (اسم، هاتف، نوع النشاط، روابط)
- [ ] زر "أضف كـ Lead" من اللوحة الجانبية مباشرة
- [ ] إضافة الصفحة للـ sidebar بأيقونة متصفح

## التحسينات الجديدة (الدفعة الثانية)
- [x] فلتر مصدر البحث في صفحة البحث (إنستغرام، فيسبوك، تيليغرام، Google Maps، الكل)
- [x] روابط مباشرة تفتح المنصة المختارة بكلمة البحث تلقائياً
- [x] صفحة Browser Scout مع نموذج استخراج بيانات يدوي
- [x] حفظ تلقائي (auto-save) بعد 2.5 ثانية من توقف الكتابة بدون زر
- [x] تحليل مباشر مدمج في صفحة بيانات العميل (LeadDetail)
- [x] تحديث تصدير CSV: كل بيانات العميل + تحليل الموقع + تحليل سوشيال في صف واحد

## التطوير الشامل - الدفعة الثالثة

### فلتر الدول والمدن
- [x] إضافة حقل country للـ leads في قاعدة البيانات
- [x] قاموس شامل: 10+ دول عربية مع مدنها الرئيسية (shared/countries.ts)
- [x] فلتر الدولة → يحدث قائمة المدن تلقائياً في جميع الصفحات
- [x] تحديث صفحة Leads بفلتر الدولة والمدينة
- [x] تحديث صفحة AddLead بفلتر الدولة والمدينة
- [ ] تحديث صفحة Search بفلتر الدولة والمدينة
- [ ] تحديث Dashboard بإحصائيات حسب الدولة

### محرك البحث الذكي في الخلفية
- [x] جدول search_jobs في قاعدة البيانات (المهمة، الحالة، التقدم، النتائج)
- [x] tRPC router لإدارة مهام البحث (إنشاء، متابعة، إيقاف)
- [x] خوارزمية البحث المنهجي: تقسيم المدينة لمناطق + بحث متعدد الكلمات
- [x] منع التكرار: فحص رقم الهاتف والاسم قبل الإضافة
- [x] تأخير بشري عشوائي بين الطلبات (2-5 ثوانٍ)
- [x] صفحة "محرك البحث" مع واجهة إنشاء مهام وتتبع حي
- [x] مؤشر تقدم حي مع عداد النتائج المكتشفة
- [x] إشعار عند اكتمال المهمة

## محرك البحث متعدد المنصات - الدفعة الرابعة
- [x] خيار Google Maps: بحث تلقائي كامل عبر Places API
- [x] خيار سناب شات: يفتح بحث سناب + نموذج استخراج يدوي
- [x] خيار إنستغرام: يفتح بحث إنستغرام + نموذج استخراج يدوي
- [x] خيار تيك توك: يفتح بحث تيك توك + نموذج استخراج يدوي
- [x] خيار فيسبوك: يفتح بحث فيسبوك + نموذج استخراج يدوي
- [x] خيار معروف.sa: يفتح معروف مع الكلمة المفتاحية + نموذج استخراج يدوي
- [x] خيار الكل: يشغّل Google Maps تلقائياً + يفتح باقي المنصات في تبويبات
- [x] واجهة موحدة: اختيار المنصة يغير طريقة العمل (تلقائي vs يدوي)
- [x] مؤشر واضح: "تلقائي كامل" أو "يدوي مساعد" لكل منصة

## الدفعة الخامسة - تحسينات جوهرية
- [x] تغيير اسم التطبيق إلى "بحثي - مجمع البيانات"
- [x] رفع حد الـ Leads إلى ما لا نهاية (إزالة الحد 400)
- [x] تحديث لوحة التحكم لعرض التقدم بدون حد (∞)
- [x] دمج AI في البحث اليدوي: توليد استراتيجية بحث ذكية لكل منصة ونشاط
- [x] AI يقترح hashtags وكلمات بحث مخصصة لكل نشاط ومنصة
- [x] AI يحلل البيانات المدخلة يدوياً ويقيّم جودة العميل (1-10)
- [x] AI يقترح زاوية التواصل المثلى بناءً على نوع النشاط والمنصة

## الدفعة السادسة - تاريخ السوشيال + تحليل تلقائي
- [x] إضافة حقل socialSince (تاريخ الظهور على السوشيال) في schema
- [x] migration لإضافة العمود الجديد
- [x] تحديث DB helpers لدعم socialSince
- [x] تحديث leads.create ليُشغّل التحليل تلقائياً بعد الحفظ (setImmediate)
- [x] تحديث صفحة AddLead بحقل socialSince
- [x] تحديث صفحة LeadDetail لعرض socialSince
- [x] تحديث صفحة Leads لعرض socialSince في الجدول

## الدفعة السابعة - نظام واتساب المتكامل

- [ ] إضافة حقل hasWhatsapp + whatsappCheckedAt في جدول leads
- [ ] إضافة جدول whatsapp_messages لتتبع الرسائل المرسلة
- [ ] migration لإضافة الحقول والجدول الجديد
- [ ] tRPC router: checkWhatsapp (فحص وجود واتساب عبر wa.me)
- [ ] tRPC router: generateWhatsappMessage (AI يولد رسالة مخصصة)
- [ ] tRPC router: logWhatsappMessage (تسجيل الرسالة المرسلة)
- [ ] tRPC router: bulkWhatsapp (إرسال مجمع لقائمة عملاء)
- [ ] زر فحص واتساب في LeadDetail مع مؤشر ✅/❌
- [ ] زر "إرسال واتساب" يفتح wa.me مع الرسالة المولّدة بالـ AI
- [ ] صفحة الإرسال المجمع في Leads: اختيار عملاء + توليد رسائل + إرسال
- [ ] عرض حالة واتساب في جدول Leads (أيقونة ملونة)

## الدفعة الثامنة - ميزات متقدمة

- [x] تعديل تأخير واتساب إلى 10 ثواني بين الرسائل (قابل للضبط 3-60 ثانية)
- [x] نظام دعوة المستخدمين بالإيميل مع التحكم بالصلاحيات
- [x] جدول invitations وuser_permissions وwhatsapp_settings وauto_reply_rules في قاعدة البيانات
- [x] صفحة إدارة المستخدمين والصلاحيات (للأدمن فقط) - /users
- [x] صفحة قبول الدعوة - /join?token=...
- [x] ربط أكثر من واتساب (multi-account) - البنية جاهزة
- [x] تبويب الإعدادات في صفحة واتساب مع عرض المحادثات
- [x] تنبيهات الرسائل بعد كل N رسالة (قابل للضبط)
- [x] نظام الرد التلقائي بالذكاء الاصطناعي مع كلمات تفعيل قابلة للتخصيص
- [x] سياق الذكاء الاصطناعي مخصص لكل قاعدة رد
- [x] 16 اختبار Vitest تمر بنجاح

## الدفعة التاسعة - صفحة المحادثات الكاملة

- [x] تحسين backend: إضافة sendChatMessage وmarkAsRead وsearchChats وdeleteChat وgetChatStats
- [x] صفحة /chats: قائمة المحادثات مع بحث وفلتر وعداد الرسائل غير المقروءة
- [x] شات مدمج: عرض سجل الرسائل مع تمييز الصادر والوارد وفواصل التاريخ
- [x] إرسال رسالة مباشرة من الشات
- [x] أرشفة وحذف المحادثات
- [x] ربط المحادثة بالعميل (Lead) مع رابط مباشر
- [x] إضافة صفحة المحادثات للـ sidebar

## الدفعة العاشرة - إعدادات OpenAI Assistant والتحكم بالرد التلقائي

- [x] إضافة جدول ai_settings في قاعدة البيانات (API Key، Assistant ID، System Prompt، إعدادات)
- [x] إضافة حقل aiAutoReplyEnabled في جدول whatsapp_chats (تحكم فردي لكل عميل)
- [x] migration وتطبيق التغييرات
- [x] backend: حفظ وجلب إعدادات AI (إخفاء API Key)
- [x] backend: توليد رد AI باستخدام OpenAI API Key الخاص أو Assistant
- [x] backend: تحكم جماعي - تفعيل/إيقاف الرد لجميع العملاء
- [x] backend: تحكم فردي - تفعيل/إيقاف الرد لعميل محدد
- [x] صفحة /ai-settings: ربط API Key + Assistant ID + System Prompt
- [x] صفحة /ai-settings: اختبار الاتصال بـ OpenAI
- [x] صفحة /ai-settings: مفتاح تفعيل/إيقاف الكل
- [x] صفحة /ai-settings: تحكم فردي لكل محادثة

## الدفعة الحادية عشرة - حسابات واتساب متعددة الأدوار + تحويل للموظف

- [x] جدول whatsapp_accounts: دور (bulk_sender/human_handoff/both)، رقم الواتساب، اسم الموظف، الترتيب
- [x] جدول interest_alerts: تسجيل إشعارات اهتمام العملاء مع حالة التحويل
- [x] migration وتطبيق التغييرات
- [x] backend: CRUD لحسابات واتساب (إضافة/تعديل/حذف/تغيير الدور)
- [x] backend: كشف اهتمام العميل (كلمات مفتاحية + AI) وإنشاء إشعار وإشعار للمالك
- [x] backend: تحويل المحادثة لرقم موظف (رابط wa.me مع بيانات العميل)
- [x] backend: قائمة الإشعارات مع حالة التحويل وإحصائيات
- [x] صفحة /whatsapp-accounts: بطاقات الحسابات مع تحديد الدور وتفعيل/إيقاف
- [x] صفحة /whatsapp-accounts: لوحة إشعارات الاهتمام مع زر التحويل ورابط واتساب
- [x] رابط حسابات واتساب في الـ sidebar تحت قسم الإدارة

## الدفعة الثانية عشرة - توحيد واتساب + كلمات مفتاحية AI + نظام المستخدمين

- [x] توحيد صفحة واتساب: تبويبات موحدة (الربط، القوالب، الإرسال، الإعدادات)
- [x] صفحة /interest-keywords: إدارة كلمات كشف الاهتمام + تدريب AI + اختبار
- [x] 23 كلمة مفتاحية افتراضية مقسمة على 5 فئات (price, buy, interest, contact, general)
- [x] نظام الصلاحيات في الـ sidebar: إخفاء الروابط حسب صلاحيات المستخدم تلقائياً
- [x] جدول interest_keywords وai_training_examples في قاعدة البيانات
- [ ] توحيد صفحة whatsapp-accounts دمجها في صفحة واتساب (مستقبلي)
- [ ] إرسال إيميل فعلي عند إنشاء الدعوة (مستقبلي)

## الدفعة الثالثة عشرة - دمج صفحتي واتساب (حسابات متعددة)

- [ ] فحص الكود الحالي لصفحة WhatsApp.tsx وWhatsAppAccounts.tsx
- [ ] تحديث backend: إضافة accountId لكل QR session وربطه بجدول whatsapp_accounts
- [ ] بناء صفحة واتساب الموحدة: قائمة الحسابات + QR لكل حساب + دور + تفعيل/إيقاف
- [ ] حذف صفحة WhatsAppAccounts.tsx المستقلة
- [ ] تحديث الـ sidebar لإزالة رابط "حسابات واتساب" المكرر

## الدفعة الرابعة عشرة - نظام الشرائح والفلترة المتقدمة

- [ ] جدول segments في قاعدة البيانات (اسم، وصف، لون، أوقات الإرسال المثلى)
- [ ] جدول lead_segments لربط العملاء بالشرائح
- [x] migration وتطبيق التغييرات
- [ ] backend: CRUD الشرائح + إضافة/حذف عملاء + إحصائيات
- [ ] backend: فلترة العملاء بالشريحة في leads.list
- [ ] صفحة /segments: إنشاء وإدارة الشرائح مع عرض العملاء
- [ ] فلترة متقدمة في صفحة العملاء (المدينة، المصدر، الحالة، الشريحة، التاريخ)
- [ ] إضافة عميل/مجموعة عملاء لشريحة من صفحة العملاء
- [ ] ربط الشريحة بصفحة الإرسال الجماعي (إرسال لشريحة محددة)
- [ ] جدولة الإرسال حسب الوقت المثلى لكل شريحة

## الدفعة 36 - إصلاحات حرجة (25 فبراير 2026)

- [x] إصلاح تكرار الرسائل 3 مرات: جعل sessions Map و incomingMessageHandler و processedMessageIds كـ global variables تبقى بين HMR reloads
- [x] تثبيت gTTS على Python 3.11 لإصلاح ميزة الرد الصوتي
- [x] إصلاح خطأ TypeScript في global declaration (استخدام `global as any` بدلاً من `declare global`)
- [x] التحقق من صحة عرض الصور في واجهة المحادثة (mediaType يُخزن بشكل صحيح)
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة الخامسة عشرة - مراجعة شاملة + ميزات جديدة

- [x] إصلاح خطأ segments.list (أعمدة مفقودة في قاعدة البيانات: optimalSendTimes, filterCriteria, isActive, updatedAt)
- [x] إصلاح خطأ getChatMessages عند chatId=null (إضافة guard في backend)
- [x] إصلاح إرسال واتساب في LeadDetail (يرسل عبر النظام الداخلي بدلاً من wa.me خارجياً)
- [x] إعادة تصميم صفحة واتساب: دمج تبويب الربط مع الحسابات + دعم 10 أجهزة
- [x] إضافة فلتر "واتساب فعّال" في قائمة العملاء
- [x] إضافة زر "تحليل جماعي" بضغطة واحدة لتحليل العملاء المحددين
- [x] إضافة bulkAnalyze procedure في analysisRouter
- [x] إضافة hasWhatsapp كفلتر في leads.list procedure وdb.ts
- [x] إنشاء صفحة إعدادات البيانات (/data-settings) مع قوائم منسدلة قابلة للتخصيص
- [x] إنشاء جدول data_settings في قاعدة البيانات
- [x] إنشاء dataSettingsRouter مع CRUD كامل
- [x] تحديث AddLead.tsx لاستخدام القوائم الديناميكية من data_settings
- [x] إضافة "إعدادات البيانات" في قائمة التنقل
- [x] إضافة علامة "واتساب فعّال" في بطاقات العملاء
- [x] 16 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)

## صفحة التقارير الموحدة
- [x] إنشاء صفحة /reports: تقارير واتساب + عملاء + أداء + ذكاء اصطناعي + أسبوعي
- [x] إصلاح جميع أخطاء TypeScript في Reports.tsx
- [x] إضافة رابط "التقارير الموحدة" في القائمة الجانبية (قسم التحليلات والأداء)
- [x] 40 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)

## الدفعة السادسة عشرة - الإرسال الجماعي لعملاء واتساب فعّال

- [x] backend: bulkSend procedure مع دعم اختيار الحساب والقالب والتأخير
- [x] تحديث Leads.tsx: checkbox لكل عميل + تحديد الكل + زر إرسال جماعي
- [x] فلتر تلقائي: إظهار عدد العملاء ذوي واتساب فعّال في زر الإرسال
- [x] نافذة الإرسال الجماعي: اختيار الحساب + القالب/AI + أسلوب الرسالة + إعداد التأخير
- [x] شريط تقدم حي أثناء الإرسال مع عداد الناجح/الفاشل/المتبقي
- [x] إمكانية إيقاف واستئناف الإرسال في أي وقت
- [x] تسجيل نتائج الإرسال في جدول whatsapp_messages

## الدفعة السابعة عشرة - تطوير شامل

- [ ] تحديد واتساب يدوياً (لديه/ليس لديه/غير محدد) في نموذج إضافة العميل
- [ ] تلقائياً: عند إضافة عميل يكون "غير محدد" افتراضياً مع إمكانية التغيير
- [ ] صفحة إعدادات AI: أسلوب التحليل، صيغة الرسائل، هوية البلد والبراند
- [ ] دمج كشف الاهتمام وشرائح العملاء في إعدادات البيانات
- [ ] صفحة رفع جماعي عبر Excel/CSV مع template قابل للتنزيل
- [ ] تحسين المحادثات: إرسال جماعي من صفحة المحادثات
- [ ] ربط حساب واتساب محدد بكل موظف/مستخدم لتحديد الرقم المرسل منه
- [ ] في نافذة الإرسال الجماعي: إظهار الحساب المخصص للمستخدم الحالي تلقائياً
- [ ] إدارة المستخدمين: إضافة حقل "حساب واتساب افتراضي" لكل موظف

## الدفعة الثامنة عشرة - ربط واتساب بالموظفين + إصلاحات
- [x] إصلاح خطأ TypeScript في invitations router (نوع accountId)
- [x] إضافة procedure setDefaultWhatsappAccount في invitations router
- [x] تحديث صفحة إدارة المستخدمين: إضافة قائمة اختيار حساب واتساب لكل موظف
- [x] عرض حساب واتساب الافتراضي مباشرة في بطاقة كل مستخدم
- [x] إمكانية تغيير حساب واتساب الموظف من نافذة تعديل الصلاحيات
- [x] التحقق: نموذج إضافة عميل يحتوي على خيار تحديد حالة واتساب يدوياً
- [x] التحقق: نافذة الإرسال الجماعي تحتوي على اختيار حساب الإرسال
- [x] 16 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)

## الدفعة التاسعة عشرة - المتطلبات الشاملة

- [ ] تحديث قاعدة البيانات: إضافة أعمدة stage, priority, nextStep, nextFollowup, ownerUserId للعملاء
- [ ] تحديث قاعدة البيانات: إضافة عمود accountType لجدول whatsapp_accounts (collection/sales/analysis/followup)
- [ ] نظام التصنيف الإلزامي في صفحة إضافة/تعديل العميل
- [ ] منع إرسال رسالة لعميل "مهتم" بدون موعد متابعة
- [ ] إضافة نوع الرقم عند تسجيل حساب واتساب جديد
- [ ] شاشة مستقلة لإدارة الأرقام مع إحصائيات
- [ ] إعادة تنظيم السايدبار بالتقسيم المقترح
- [ ] نظام منع التكرار: توحيد الأرقام + منع الإدخال المكرر
- [x] حالة مقروء/غير مقروء في المحادثات + عداد الرسائل غير المقروءة في السايدبار
- [ ] دعم الإيموجي في المحادثات
- [ ] رفع جماعي CSV/Excel في صفحة إضافة عميل
- [ ] نظام التنبيهات التلقائي
- [ ] توحيد الإعدادات في صفحة واحدة

## الدفعة العشرون - ربط العملاء بالمحادثات

- [x] إضافة procedure getTotalUnread في waSettings router لجلب إجمالي الرسائل غير المقروءة
- [x] عرض عداد الرسائل غير المقروءة في السايدبار (رابط المحادثات) مع تحديث كل 10 ثوانٍ
- [x] إضافة زر "فتح المحادثة" في صفحة تفاصيل العميل (LeadDetail) ضمن قسم واتساب
- [x] دعم query parameters في صفحة Chats: ?phone=xxx&name=xxx لفتح نموذج محادثة جديدة مباشرة
- [x] إضافة حقل "اسم العميل" في نموذج المحادثة الجديدة

## الدفعة العشرون - ربط العملاء بالمحادثات

- [x] إضافة procedure getTotalUnread في waSettings router لجلب إجمالي الرسائل غير المقروءة
- [x] عرض عداد الرسائل غير المقروءة في السايدبار (رابط المحادثات) مع تحديث كل 10 ثوانٍ
- [x] إضافة زر "فتح المحادثة" في صفحة تفاصيل العميل (LeadDetail) ضمن قسم واتساب
- [x] دعم query parameters في صفحة Chats: ?phone=xxx&name=xxx لفتح نموذج محادثة جديدة مباشرة
- [x] إضافة حقل "اسم العميل" في نموذج المحادثة الجديدة

## الدفعة الحادية والعشرون - نظام AI+RAG وتطوير الشات

- [x] إضافة جداول RAG في قاعدة البيانات (ragDocuments, ragChunks, ragConversationExamples, aiPersonality)
- [x] بناء ragKnowledge router في الخادم (إضافة/حذف/بحث/تحديث المعرفة)
- [x] إعادة تصميم شامل لشات واتساب (فقاعات خضراء/رمادية مع ذيل، ألوان واتساب)
- [x] سكرول منفرد لكل محادثة (overflow-y-auto مستقل داخل نافذة الشات)
- [x] ربط AI بقاعدة RAG عند توليد الردود الاحترافية (generateRagReply)
- [x] بناء صفحة إدارة قاعدة المعرفة (KnowledgeBase) /knowledge-base
- [x] إضافة مسار /knowledge-base في App.tsx والسايدبار
- [ ] دعم رفع ملفات PDF/Word/TXT لقاعدة المعرفة (مستقبلي)
- [x] تدريب AI على أسلوب الرد (system prompt + شخصية AI قابلة للتخصيص)
- [x] لوحة AI في الشات: عرض الرد المقترح مع إمكانية التعديل قبل الإرسال
- [x] زر تشغيل/إيقاف الرد التلقائي AI لكل محادثة منفردة (toggle في رأس الشات)
- [x] زر تشغيل/إيقاف الرد التلقائي AI لجميع المحادثات دفعة واحدة (في الشريط العلوي)
- [x] عرض حالة الرد التلقائي في بطاقة كل محادثة (أيقونة Bot خضراء/رمادية)
- [x] إضافة setBulkChatAutoReply لدعم accountId "all" (جميع المحادثات)

## الدفعة الثانية والعشرون - إصلاح الشات + إعادة ترتيب السايدبار

- [ ] تسجيل جهة الاتصال تلقائياً: أولوية اسم واتساب > اسم Lead > رقم الهاتف
- [ ] إصلاح ظهور حالات جهات التواصل داخل الشات
- [ ] إصلاح ظهور محادثات غير مطابقة
- [ ] إصلاح استقبال الرسائل في الشات
- [ ] تحسين وضوح لوحة الذكاء الاصطناعي في الردود
- [ ] إعادة ترتيب السايدبار احترافياً
- [ ] دمج "قاعدة معرفة AI" مع "إعدادات AI" في صفحة واحدة
- [ ] حذف "إضافة عميل" من السايدبار (مدمجة داخل صفحة العملاء)
- [ ] دمج "شرائح العملاء" داخل تبويب "إعدادات البيانات"

## الدفعة الثانية والعشرون - إصلاح الشات + إعادة ترتيب السايدبار

- [ ] تسجيل جهة الاتصال تلقائياً: أولوية اسم واتساب > اسم Lead > رقم الهاتف
- [ ] إصلاح ظهور حالات جهات التواصل داخل الشات
- [ ] إصلاح ظهور محادثات غير مطابقة
- [ ] إصلاح استقبال الرسائل في الشات
- [ ] تحسين وضوح لوحة الذكاء الاصطناعي في الردود
- [ ] إعادة ترتيب السايدبار احترافياً
- [ ] دمج "قاعدة معرفة AI" مع "إعدادات AI" في صفحة واحدة
- [ ] حذف "إضافة عميل" من السايدبار (مدمجة داخل صفحة العملاء)
- [ ] دمج "شرائح العملاء" داخل تبويب "إعدادات البيانات"
- [ ] دمج "رفع جماعي" داخل قائمة العملاء (تبويب أو زر في الصفحة)

## الدفعة الثانية والعشرون - إصلاح الشات + إعادة ترتيب السايدبار (مكتملة)

- [x] تسجيل جهة الاتصال تلقائياً: أولوية اسم واتساب > اسم Lead > رقم الهاتف
- [x] إصلاح تحديث اسم جهة الاتصال عند استقبال رسالة جديدة (index.ts)
- [x] إعادة كتابة Chats.tsx بالكامل مع إصلاح جميع المشاكل
- [x] إعادة ترتيب السايدبار احترافياً (المحادثات أولاً، ثم الإرسال، ثم العملاء، ثم البحث)
- [x] دمج "قاعدة معرفة AI" مع "إعدادات AI" في صفحة واحدة بتبويبات
- [x] حذف "إضافة عميل" من السايدبار (مدمجة داخل صفحة العملاء)
- [x] تغيير "رفع جماعي (Excel)" إلى "رفع جماعي" مع أيقونة Upload
- [x] إضافة "حسابات واتساب" في قسم الإدارة
- [x] تغيير عنوان "إعدادات AI" إلى "ذكاء اصطناعي AI"

## الدفعة الثالثة والعشرون - إصلاح الردود التلقائية بالـ AI
- [ ] فحص وإصلاح آلية الرد التلقائي في الخادم (index.ts)
- [ ] إصلاح generateRagReply لتعمل بشكل صحيح
- [ ] إضافة تحكم جماعي (تشغيل/إيقاف الكل) من داخل الشات
- [ ] توحيد إعدادات AI في لوحة واحدة داخل الشات
- [ ] إصلاح حفظ إعدادات AI في قاعدة البيانات

## الدفعة الرابعة والعشرون - نظام الرسائل الذكي المتكامل

- [ ] إصلاح AI toggle الفردي (يجب أن يوقف الرد عند إيقافه)
- [ ] إصلاح زر الرفع الجماعي في قائمة العملاء
- [ ] بناء نظام الإرسال الجماعي بالترتيب (توزيع على أرقام واتساب المتصلة مع حد أقصى لكل رقم)
- [ ] بناء نظام تصعيد AI للبشري (عند عجز AI يرسل إشعار لرقم واتساب محدد)
- [ ] ردود تلقائية بناءً على كلمات مفتاحية محددة
- [ ] لوحة إدارة الرسائل الموحدة (AI + بشري + إرسال جماعي)
- [ ] إضافة تحكم في عدد العملاء المستخرجة في مركز البحث
- [ ] إزالة شرائح العملاء من السايدبار (تبقى بالداخل فقط)

## الدفعة الخامسة والعشرون - إصلاحات شاملة
- [x] إصلاح منطق AI toggle الفردي (يوقف الرد عند إيقاف المحادثة حتى لو كان الإعداد العام مفعلاً)
- [x] إضافة نظام تصعيد AI (عند عجز AI يرسل إشعار لرقم واتساب محدد)
- [x] إضافة الكلمات المفتاحية لبناء المحادثة (رد تلقائي محدد عند كلمة مفتاحية)
- [x] إضافة كلمات مفتاحية تُفعّل التصعيد الفوري
- [x] إزالة شرائح العملاء من الشريط الجانبي (تبقى بالداخل فقط)
- [x] توسيع خيارات عدد العملاء المستهدف في مركز البحث (10-1000)
- [x] إضافة أعمدة التصعيد والكلمات المفتاحية لقاعدة البيانات
- [ ] إصلاح زر الرفع الجماعي (فحص مشكلة محددة)
- [ ] بناء نظام الإرسال الجماعي بالترتيب (توزيع على أرقام واتساب المتصلة مع حد أقصى لكل رقم)

## الدفعة السادسة والعشرون - تحسينات المحادثات
- [x] إخفاء رسائل جروبات الواتساب (@g.us) من المحادثات
- [x] إخفاء رسائل القصص والحالات (status@broadcast) من المحادثات
- [x] إخفاء رسائل الفيسبوك/ميتا من المحادثات
- [x] عرض رقم الواتساب المُرسِل عند تعدد الأرقام (badge أخضر أنيق)
- [x] إظهار التاريخ الكامل عند hover على وقت الرسالة

## الدفعة السابعة والعشرون - الترقية الشاملة
- [x] إضافة حقول سكور الأرقام في جدول whatsapp_accounts (healthScore, healthStatus, dailySentCount, etc.)
- [x] إضافة جداول backup_logs وscheduled_sends في قاعدة البيانات
- [x] إضافة حقول الصوت في جدول ai_settings (voiceReplyEnabled, voiceDialect, voiceGender, voiceSpeed, transcribeIncoming)
- [x] بناء numberHealth router (سكور الأرقام + إحصائيات + تحديث يدوي)
- [x] صفحة /number-health: سكور صحة كل رقم واتساب مع مؤشرات بصرية
- [x] إضافة قسم الرد الصوتي في إعدادات AI (اللهجة، الجنس، السرعة)
- [x] إضافة قسم تحويل الصوت لنص في إعدادات AI
- [x] إضافة رابط "صحة الأرقام" في السايدبار

## الدفعة الثامنة والعشرون - علامات القراءة + توزيع الموظفين + تحليل الأداء

### علامات القراءة (محاكاة واتساب)
- [ ] إضافة حقل messageStatus في جدول whatsapp_chat_messages (sent/delivered/read)
- [x] migration وتطبيق التغييرات
- [ ] backend: procedure لتحديث حالة الرسالة عند القراءة
- [ ] واجهة: علامة ✓ رمادية = أُرسلت، ✓✓ رمادية = وصلت، ✓✓ زرقاء = قُرئت

### نظام توزيع المحادثات على الموظفين
- [ ] إضافة حقل assignedUserId في جدول whatsapp_chats
- [x] migration وتطبيق التغييرات
- [ ] backend: procedure لتعيين موظف لمحادثة
- [ ] backend: procedure لجلب محادثات موظف محدد
- [ ] واجهة: زر "تعيين لموظف" في رأس الشات مع قائمة الموظفين
- [ ] واجهة: فلتر المحادثات حسب الموظف المعيّن

### تحليل أداء الموظفين
- [ ] backend: procedure لتحليل أداء كل موظف (عدد المحادثات، متوسط وقت الرد، معدل الإغلاق)
- [ ] backend: كشف الفرص المهجورة (محادثات لم يُرد عليها > X ساعة)
- [ ] backend: تحليل AI لأسلوب الموظف وكشف نقاط الضعف
- [ ] صفحة /employee-performance: تقارير أداء كل موظف

### تقارير المحادثات
- [ ] backend: إحصائيات المحادثة (مدة، عدد الرسائل، وقت أول رد، معدل الرد)
- [ ] backend: كشف الفرص الضائعة (عميل مهتم لم يُتابَع)
- [ ] صفحة /conversation-reports: تقارير شاملة مع رسوم بيانية

### النسخ الاحتياطي اليومي
- [ ] cron job يومي لتصدير البيانات
- [ ] إرسال النسخة على الإيميل تلقائياً

### تنقيب إنستغرام
- [ ] ربط Meta Business API
- [ ] البحث بكلمات مفتاحية وهاشتاقات
- [ ] استخراج الحسابات وإضافتها كعملاء محتملين

## الدفعة التاسعة والعشرون - إعادة الترتيب الشاملة + تحليل التسويق الرقمي
- [x] إعادة ترتيب القائمة الجانبية بشكل احترافي (7 مجموعات منظمة)
- [x] إضافة صفحة تحليل التسويق الرقمي الشاملة (/digital-marketing)
- [x] بناء digitalMarketing router مع 6 procedures
- [x] تحسين Dashboard.tsx بتصميم احترافي محسّن
- [x] إصلاح startWhatsAppSession لا ينتظر 40 ثانية (يبدأ في الخلفية)
- [x] تحديث refetchInterval في allStatus query من 4 ثانية إلى 2 ثانية

## الدفعة الثلاثون - الحملات + التذكيرات + التقرير الأسبوعي
- [x] جدول campaigns في قاعدة البيانات (اسم، تاريخ، عدد المرسل، عدد الاستجابة، معدل الاستجابة)
- [x] جدول reminders في قاعدة البيانات (leadId، تاريخ، نوع، حالة)
- [x] migration وتطبيق التغييرات
- [x] campaigns router: قائمة الحملات + إحصائيات + رسم بياني
- [x] reminders router: قائمة التذكيرات + إضافة + تحديث حالة
- [x] weekly_report router: توليد تقرير PDF + إرسال واتساب
- [x] تبويب "الحملات" في صفحة التسويق الرقمي مع رسوم بيانية
- [x] صفحة التذكيرات /reminders مع زر "اتصل الآن"
- [x] نظام التذكير التلقائي (فحص كل ساعة للعملاء غير المتابَعين)
- [x] زر "إنشاء تقرير أسبوعي" في لوحة التحكم
- [x] إرسال التقرير عبر واتساب للمالك

## الدفعة الحادية والثلاثون - ميزة تنشيط التواصل
- [ ] جدول activation_sessions في قاعدة البيانات
- [ ] جدول activation_settings لإعدادات التنشيط
- [ ] migration وتطبيق التغييرات
- [ ] activation router: بدء/إيقاف التنشيط + إحصائيات
- [ ] خوارزمية إرسال رسائل طبيعية عشوائية بين الأرقام
- [ ] رسائل متنوعة (تحيات، أسئلة، ردود طبيعية)
- [ ] تأخير عشوائي بين الرسائل (30 ثانية - 5 دقائق)
- [ ] صفحة /activation مع لوحة تحكم كاملة
- [ ] إضافة الصفحة للقائمة الجانبية

## الدفعة الثلاثون - RAG وGoogle Sheets
- [ ] إصلاح أخطاء SQL في digitalMarketing.ts (DATE_SUB)
- [ ] إنشاء جدول knowledge_base في قاعدة البيانات
- [ ] بناء RAG router مع embeddings وبحث دلالي
- [ ] ربط Google Sheets كمصدر للـ RAG
- [ ] ربط RAG بالرد التلقائي على واتساب
- [ ] صفحة إدارة قاعدة المعرفة في الـ frontend
- [ ] بناء صفحة الإعدادات الموحدة بتبويبات منظمة
- [ ] تحسين صفحة التقارير وتقسيمها بدقة
- [ ] بناء صفحة الإعدادات الموحدة بتبويبات منظمة
- [ ] تحسين صفحة التقارير وتقسيمها بدقة

## جدولة إرسال التقارير الأسبوعية تلقائياً
- [x] إضافة جدول report_schedules في قاعدة البيانات (يوم الأسبوع، الساعة، مفعّل، آخر إرسال)
- [x] migration وتطبيق التغييرات
- [x] backend: procedure لحفظ/جلب/تعديل إعدادات الجدولة
- [x] backend: cron job يعمل كل دقيقة ويفحص إذا حان وقت الإرسال
- [x] واجهة إعدادات الجدولة في تبويب "أسبوعي" بصفحة التقارير
- [x] 40 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)

## إصلاح أخطاء SQL وإعادة ترتيب القائمة
- [x] إصلاح أخطاء SQL في whatsapp_chat_messages (حقل phone غير موجود في الجدول - استبدلناه بـ chatId)
- [x] إزالة "شرائح العملاء" من القائمة الجانبية الخارجية
- [x] نقل تبويب "شرائح العملاء" داخل صفحة إعدادات البيانات

## دمج الصفحات داخل التقارير وتنظيف القائمة
- [ ] دمج "تقرير الإرسال" كتبويب في صفحة /reports
- [ ] دمج "صحة الأرقام الذكي" كتبويب في صفحة /reports
- [ ] دمج "أداء الموظفين" كتبويب في صفحة /reports
- [ ] تجميع كل ما يخص واتساب في تبويب واحد داخل التقارير
- [ ] إزالة تقرير الإرسال وصحة الأرقام وأداء الموظفين من القائمة الجانبية

## دمج الصفحات داخل التقارير
- [x] دمج تقرير الإرسال (WhatsAppReport.tsx) كتبويب فرعي داخل تبويب واتساب
- [x] دمج صحة الأرقام (NumberHealth.tsx) كتبويب فرعي داخل تبويب واتساب
- [x] دمج أداء الموظفين (EmployeePerformance.tsx) كتبويب فرعي داخل تبويب الأداء
- [x] حذف الصفحات الثلاث من القائمة الجانبية (تقرير الإرسال + صحة الأرقام + أداء الموظفين)
- [x] تبويب واتساب يحتوي على 3 تبويبات فرعية: ملخص + تقرير الإرسال + صحة الأرقام
- [x] 40 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)

## التطوير الشامل للشات والذكاء الاصطناعي الصوتي
- [ ] نظام الأرشفة: backend procedure + إعدادات مدة الأرشفة التلقائية
- [ ] واجهة الأرشفة: زر أرشفة في كل محادثة + تبويب الأرشيف + فلتر
- [ ] عرض الصور: lightbox احترافي + thumbnail + تكبير/تصغير
- [ ] عرض الملفات: أيقونة نوع الملف + اسم + حجم + زر تحميل
- [ ] عرض الصوت: مشغل صوتي مدمج مع شريط تقدم + مدة
- [ ] الذكاء الاصطناعي الصوتي: تسجيل صوت المستخدم + Whisper transcription
- [ ] الذكاء الاصطناعي الصوتي: رد AI بصوت بشري عبر TTS
- [ ] تحكم فردي: تفعيل الصوت لمحادثة معينة حتى لو كان الكل مغلقاً
- [ ] إصلاح إعدادات مركز البحث (ضياع الإعدادات)
- [ ] تحسين أداء الشات: virtualization للرسائل الكثيرة
- [ ] تحسين التمرير: auto-scroll ذكي + زر "انتقل لآخر رسالة"

## التطوير الشامل للشات والذكاء الاصطناعي الصوتي
- [x] أرشفة المحادثات: جماعي + تلقائي + إعدادات مدة الأرشفة
- [x] عرض الصور بـ lightbox + مشغّل صوت مخصص + عرض الملفات
- [x] ذكاء اصطناعي صوتي: STT (تحويل صوت لنص) + TTS (رد بصوت بشري)
- [x] إعدادات الصوت: اختيار الصوت + سرعة الكلام
- [x] 40 اختبار Vitest تمر بنجاح (0 أخطاء TypeScript)

## إصلاحات الشات والصوت والأداء
- [ ] إصلاح ربط الرسائل الواردة من واتساب الحقيقي مع الشات (polling/webhook)
- [ ] تحديث الشات تلقائياً عند وصول رسائل جديدة بدون إعادة تحميل
- [ ] إصلاح الصوت TTS/STT (لا يعمل حالياً)
- [ ] إضافة virtual scrolling للمحادثات الكثيرة
- [ ] إصلاح إعدادات مركز البحث

## الدفعة الثالثة والثلاثون - إصلاح الرد التلقائي على الرسائل الصوتية
- [x] إضافة دعم الرسائل الصوتية في الرد التلقائي: تحويل الصوت لنص باستخدام Whisper API ثم إرساله للـ AI
- [x] إصلاح شرط الرد التلقائي: كان يشترط message.trim() فقط والرسائل الصوتية تصل بـ message="" فكان يتجاهلها
- [x] استخدام effectiveMessage في جميع مراحل المعالجة (RAG وكلمات مفتاحية وتصعيد وإرسال للـ AI)
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة الثانية والثلاثون - إصلاحات وميزات جديدة
- [x] إصلاح خطأ Drizzle ORM في getDailyMessageStats وgetCampaignStats (استبدال db.select().groupBy() بـ db.execute() لتجنب مشكلة GROUP BY DATE())
- [x] إصلاح getOverviewStats: استخدام db.execute() لاستعلام الرسائل بدلاً من db.select()
- [x] تعديل منطق AI AutoReply: يرد إذا كان chatAutoReply مفعلاً حتى لو كان globalEnabled معطلاً (تفعيل AI لمحادثة واحدة)
- [x] إضافة إشعار صوتي عند وصول رسائل واتساب جديدة (نغمتان متتاليتان باستخدام Web Audio API)
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة الرابعة والثلاثون - تحسينات الرسائل الصوتية
- [x] إصلاح system prompt الافتراضي: إزالة "أنا مساعد نصي فقط" وإضافة تعليمات للرسائل الصوتية
- [x] إضافة مؤشر "يعالج الصوت" في الواجهة عبر SSE event جديد
- [x] تحسين system prompt ليذكر أن الرسائل الصوتية تُحوَّل لنص وقد تحتوي أخطاء

## الدفعة الخامسة والثلاثون - ميزة الرد الصوتي للـ AI
- [x] فحص TTS API المتاح وإعداد خدمة تحويل النص لصوت (server/_core/tts.ts)
- [x] دمج TTS في تدفق الرد التلقائي: تحويل رد AI لصوت ورفعه لـ S3 وإرساله كمرفق واتساب
- [x] إضافة خيار تفعيل الرد الصوتي في إعدادات AI مع اختيار الصوت (alloy, nova, shimmer...)
- [x] إضافة عمود ttsVoice في جدول ai_settings

## الدفعة السادسة والثلاثون - خيار نطاق الرد الصوتي ومشغّل صوتي في الشات
- [ ] إضافة عمود voiceReplyScope في جدول ai_settings (قيم: voice_only / all_messages)
- [ ] إضافة voiceReplyScope في schema validation وmutation handler في aiSettings.ts
- [ ] إضافة خيار نطاق الرد الصوتي في واجهة إعدادات AI
- [ ] تعديل منطق الرد التلقائي في index.ts لاحترام voiceReplyScope
- [ ] عرض مشغّل صوتي في الشات للردود الصوتية التي أرسلها AI

## الدفعة السادسة والثلاثون - نطاق الرد الصوتي وتحسينات TTS
- [x] إضافة عمود voiceReplyScope في جدول ai_settings
- [x] تحديث schema.ts بعمود voiceReplyScope
- [x] إضافة voiceReplyScope في aiSettings router (validation + mutation)
- [x] تحديث منطق الرد التلقائي في index.ts لاحترام voiceReplyScope
- [x] إضافة خيار نطاق الرد الصوتي في واجهة AISettings.tsx (صوتية فقط / جميع الرسائل)
- [x] إصلاح __dirname في tts.ts لـ ES modules
- [x] استبدال FORGE TTS بـ gTTS (Python) لأن FORGE لا يدعم TTS
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة السابعة والثلاثون - إصلاح تكرار إرسال الرسائل
- [x] فحص سبب إرسال الرسائل 3 مرات: كان الـ message listener يُسجَّل عدة مرات بسبب إعادة تشغيل الـ client
- [x] إضافة deduplication بناءً على messageId في whatsappAutomation.ts لمنع معالجة نفس الرسالة أكثر من مرة
- [x] تثبيت gTTS والتحقق من عمله بشكل صحيح
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة الثامنة والثلاثون - إصلاح الصور والملفات والرد الصوتي
- [ ] إصلاح عدم ظهور الصور والملفات المرسلة في الشات
- [ ] إصلاح الرد الصوتي بشكل نهائي

## الدفعة 37 - الرد الصوتي الكامل + مؤشر TTS + Fallback ذكي

- [ ] إصلاح الرد الصوتي end-to-end: فحص وإصلاح مشكلة إرسال ملف MP3 عبر واتساب
- [ ] إضافة جدول tts_logs في قاعدة البيانات لتتبع حالة TTS
- [ ] backend: تسجيل كل محاولة TTS (نجاح/فشل، الوقت، الحجم، نوع الرسالة)
- [ ] إضافة مؤشر حالة TTS في لوحة إعدادات AI (آخر رد صوتي، نسبة النجاح، إحصائيات)
- [ ] إضافة fallback ذكي: عند فشل TTS يُرسل الرد نصياً مع إشعار للمشرف
- [ ] 40 اختبار Vitest تمر بنجاح

## الدفعة 37 (مكتملة) - الرد الصوتي الكامل + مؤشر TTS + Fallback ذكي

- [x] إضافة جدول tts_logs في قاعدة البيانات لتتبع حالة TTS (status, durationMs, audioSizeBytes, errorMessage, voiceDialect)
- [x] backend: تسجيل كل محاولة TTS (نجاح/فشل/نصي بديل، الوقت، الحجم، نوع الرسالة)
- [x] إضافة getTtsStats procedure في aiSettings router (آخر 7 أيام: إجمالي، نجاح، فشل، نصي بديل، نسبة نجاح، متوسط الوقت)
- [x] إضافة getRecentTtsLogs procedure لجلب آخر 10 سجلات TTS
- [x] إضافة مؤشر حالة TTS في لوحة إعدادات AI (بطاقات إحصائية + شريط نسبة النجاح + جدول آخر السجلات)
- [x] إضافة fallback ذكي: عند فشل TTS يُرسل الرد نصياً مع إشعار للمشرف عبر notifyOwner
- [x] إشعار المشرف بخطأ حرج عند فشل محرك TTS بالكامل
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة 38 - إصلاح gTTS في الإنتاج + خيار اللهجة

- [x] إصلاح مشكلة "No module named gtts" في الإنتاج: تحديث gtts_helper.py ليثبّت gTTS تلقائياً عند أول استخدام
- [x] تحديث tts.ts للبحث عن gtts_helper.py في مسارات متعددة وإنشائه تلقائياً إذا لم يوجد
- [x] عمود voiceDialect موجود بالفعل في schema وrouter وواجهة AI Settings
- [x] خيارات اللهجة موجودة: سعودية، مصرية، إماراتية، كويتية، قطرية، مغربية، عربي فصيح
- [x] تحديث build script لنسخ gtts_helper.py إلى dist/
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة 39 - إصلاح خطأ API JSON

- [x] إصلاح مشكلة ECONNRESET: إضافة إعادة الاتصال التلقائي في getDb() وإضافة resetDbConnection() في reportScheduler
- [x] تأكيد: الخطأ كان مؤقتاً بسبب إعادة تشغيل sandbox - الصفحة تعمل بشكل صحيح
- [x] 40 اختبار Vitest تمر بنجاح
## الدفعة 40 - إعادة تصميم مركز البحث الاحترافي

- [ ] فحص الكود الحالي لمركز البحث وصفحات البحث الموجودة
- [ ] إعادة تصميم SearchHub.tsx بواجهة موحدة احترافية مع تبويبات للمصادر (Google Maps, Instagram, Snapchat, TikTok, Telegram)
- [ ] إضافة البحث من داخل إنستجرام - جلب الحسابات التجارية بالهاشتاق أو الموقع
- [ ] إضافة فلاتر متقدمة: المدينة، نوع النشاط، عدد المتابعين، التحقق من الواتساب
- [ ] إضافة معاينة سريعة للنتائج مع زر "إضافة كعميل" مباشرة
- [ ] إضافة تقدم البحث الحي (live progress) مع إحصائيات
- [ ] تحسين UX: بحث بالصوت، حفظ عمليات البحث، تصدير النتائج

## الدفعة 41 - Instagram API + AI Fallback + تحسين مركز البحث

- [ ] إضافة INSTAGRAM_ACCESS_TOKEN و INSTAGRAM_APP_ID كـ secrets
- [ ] تحسين instagram router: AI fallback تلقائي عند غياب API credentials
- [ ] تحسين واجهة مركز البحث: عرض نتائج إنستجرام بشكل احترافي مع صور الملفات الشخصية
- [ ] إضافة مؤشر "بحث بالذكاء الاصطناعي" عند استخدام الـ fallback
- [ ] تشغيل 40 اختبار Vitest بنجاح

## الدفعة 41 (مكتملة) - Instagram API وAI Fallback

- [x] إضافة حقول instagramAccessToken و instagramAppId و instagramApiEnabled في جدول ai_settings
- [x] تحديث aiSettings router لحفظ وقراءة Instagram credentials
- [x] إضافة قسم Instagram API في صفحة إعدادات AI (تفعيل، App ID، Access Token، دليل الحصول على Token)
- [x] تحديث instagram router ليقرأ credentials من قاعدة البيانات أولاً ثم متغيرات البيئة
- [x] إضافة AI fallback تلقائي: عند عدم وجود credentials، يستخدم الذكاء الاصطناعي لتوليد نتائج محتملة
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة 42 - نظام تعلم السلوك البشري في مركز البحث

- [x] إنشاء جدول search_behavior_logs في قاعدة البيانات (تسجيل جلسات البحث)
- [x] إنشاء جدول search_behavior_patterns (حفظ الأنماط المستخلصة)
- [x] إنشاء searchBehavior router مع endpoints: logSearchSession, getBehaviorPatterns, getBehaviorStats, enhanceQuery, getSmartSuggestions
- [x] دمج نظام تعلم السلوك في SearchHub.tsx: تتبع الجلسات، عمق التمرير، أنماط النقر
- [x] إضافة زر "تحسين بالذكاء" لتحسين الاستعلام بناءً على الأنماط المتعلمة
- [x] إضافة لوحة "أنماط متعلّمة" تعرض: نسبة النجاح، مدة الجلسة، أكثر الكلمات نجاحاً، اقتراحات ذكية
- [x] عرض الاستعلام المحسّن مع زر "استخدام"
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة 43 - إصلاح جذري: منع توليد بيانات وهمية

- [ ] فحص instagram router: حذف AI fallback الذي يولد نتائج وهمية
- [ ] فحص tiktok router: حذف توليد بيانات وهمية
- [ ] فحص snapchat router: حذف توليد بيانات وهمية
- [ ] فحص telegram router: حذف توليد بيانات وهمية
- [ ] فحص searchBehavior router: حذف enhanceQuery إذا كان يولد بيانات وهمية
- [ ] إرجاع رسالة واضحة "لا توجد نتائج حقيقية" بدلاً من البيانات المزيفة
- [ ] 40 اختبار Vitest تمر بنجاح

## الدفعة 43 - إصلاح جذري: منع البيانات الوهمية

- [x] حذف Instagram AI fallback الذي يولد حسابات وهمية عند غياب API credentials
- [x] إرجاع خطأ واضح بدلاً من بيانات مزيفة عند غياب Instagram credentials
- [x] حذف دالة generateSimulatedResults() من socialSearch.ts (كانت تولد نتائج وهمية لـ TikTok/Snapchat/Telegram)
- [x] تعديل extractBusinessesWithAI لتصبح extractBusinessesFromRealText مع قواعد صارمة: استخراج فقط ما هو موجود في النص
- [x] إضافة فلتر: حذف أي نتيجة بـ username أو name فارغ
- [x] إرجاع قائمة فارغة عند عدم توفر نص كافٍ بدلاً من توليد بيانات
- [x] إزالة fallback وهمي في SearchHub.tsx (كان يستدعي TikTok كبديل لـ Instagram)
- [x] تصحيح النص التوضيحي: "بدونه لن تظهر أي نتائج لضمان صحة البيانات"

## الدفعة 44 - تسجيل جهة الاتصال تلقائياً في واتساب

- [x] عند استقبال رسالة: تحديث contactName تلقائياً بأولوية: اسم واتساب > اسم Lead > رقم الهاتف
- [x] عند إنشاء محادثة جديدة: جلب اسم Lead من قاعدة البيانات وتعيينه كـ contactName
- [x] عند استقبال رسالة من رقم جديد: البحث في قاعدة Leads عن الرقم وتعيين الاسم تلقائياً
- [x] عرض الاسم الصحيح في قائمة المحادثات وفي رأس الشات

## الدفعة 45 - إعادة ضبط المنطق البحثي + تحسينات واتساب

- [ ] إعادة ضبط المنطق البحثي جذرياً: منع أي بيانات غير مؤكدة (أرقام/مواقع وهمية)
- [ ] تطبيق قواعد صارمة: لا يُقبل رقم هاتف إلا إذا كان موجوداً فعلاً في نص الصفحة
- [ ] تطبيق قواعد صارمة: لا يُقبل موقع إلا إذا كان URL حقيقياً قابلاً للتحقق
- [ ] إضافة زر "مزامنة الأسماء" في صفحة المحادثات لتحديث المحادثات القديمة
- [ ] إضافة رابط "عرض ملف العميل" في رأس شات واتساب

## الدفعة 45 - إعادة ضبط المنطق البحثي + واجهة اختيار البيانات الحقيقية

- [x] إعادة كتابة socialSearch.ts بمنطق صارم: regex لأرقام الهواتف والمواقع من HTML الخام
- [x] AI ممنوع من إدخال phone أو website - يستخرج الأسماء والنصوص فقط
- [x] إرجاع availablePhones وavailableWebsites كقوائم للاختيار في نموذج الإضافة
- [x] تحديث نموذج الإضافة في SearchHub: عرض الأرقام الحقيقية كأزرار للاختيار (خضراء)
- [x] تحديث نموذج الإضافة في SearchHub: عرض المواقع الحقيقية كأزرار للاختيار (زرقاء)
- [x] placeholder واضح عند عدم وجود رقم/موقع مؤكد
- [x] زر مزامنة الأسماء في رأس قائمة المحادثات
- [x] تحسين رابط ملف العميل في رأس الشات مع نص توضيحي
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة 46 - إصلاح جلب أرقام الهواتف والمواقع من Google Maps

- [x] تحديد سبب المشكلة: searchPlaces لا يُرجع الهاتف والموقع (فقط الاسم والعنوان)
- [x] إضافة استدعاء تلقائي لـ getPlaceDetails عند فتح نموذج الإضافة لنتائج Google Maps
- [x] تحديث واجهة النموذج: مؤشر تحميل "جاري الجلب من Google..." أثناء الانتظار
- [x] عرض علامة "تم الجلب من Google" بجانب الحقل عند نجاح الجلب
- [x] تعطيل حقل الإدخال أثناء الجلب لمنع التعارض
- [x] 40 اختبار Vitest تمر بنجاح

## الدفعة 47 - Puppeteer scraper لـ TikTok وSnapchat

- [x] تثبيت puppeteer-core وchromium في المشروع
- [x] بناء TikTok profile scraper: استخراج bio/phone/website من ملف التعريف
- [x] بناء Snapchat profile scraper: استخراج بيانات الاتصال من ملف التعريف
- [x] دمج Scrapers في socialSearch router
- [x] تحديث واجهة SearchHub لعرض نتائج الاستخراج المتقدم
- [x] اختبار وحفظ checkpoint
